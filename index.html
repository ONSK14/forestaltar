<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>forest altar</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #1e1e1e;
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
        }
        #chat-container {
            width: 90%;
            max-width: 600px;
            height: 80vh;
            display: flex;
            flex-direction: column;
            border-radius: 10px;
            overflow: hidden;
            background-color: #2c2c2c;
        }
        #chat-box {
            flex: 1;
            padding: 10px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }
        #input-container {
            display: flex;
            padding: 10px;
            background-color: #222;
        }
        #message-input {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            background-color: #444;
            color: white;
        }
        #send-button, #clear-button {
            background-color: #444;
            color: white;
            border: none;
            padding: 10px 15px;
            margin-left: 10px;
            border-radius: 5px;
            cursor: pointer;
        }
        #send-button:disabled {
            background-color: #666;
            cursor: not-allowed;
        }
        #clear-button {
            background-color: red;
        }
        #instructions-container {
    position: absolute;
    top: 10px;
    left: 10px;
}
        
#chat-container {/* èƒŒæ™¯å›¾ç‰‡1 */
     width: 90%;
    max-width: 600px;
    height: 80vh;
    display: flex;
    flex-direction: column;
    border-radius: 10px;
    overflow: hidden;
    background-color: #2c2c2c;
    position: relative; /* è®©èƒŒæ™¯å›¾ç‰‡ä½äºå¯¹è¯æ¡†ä¹‹ä¸Šï¼Œä½†å¯¹è¯æ°”æ³¡ä¹‹ä¸‹ */
}

/* è®©èƒŒæ™¯å›¾ç‰‡æ”¾åœ¨å¯¹è¯æ¡†ä¹‹ä¸Šï¼Œä½†å¯¹è¯æ°”æ³¡ä¹‹ä¸‹ */
#chat-container::after {
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-image: url('forestaltar.png'); /* ä½¿ç”¨ç”¨æˆ·æŒ‡å®šçš„å›¾ç‰‡ */
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;
    opacity: 0.3; /* è®¾ç½®èƒŒæ™¯å›¾ç‰‡é€æ˜åº¦ 30% */
    z-index: 1; /* ç¡®ä¿èƒŒæ™¯å›¾ç‰‡åœ¨å¯¹è¯æ¡†ä¹‹ä¸Š */
    pointer-events: none; /* é¿å…å½±å“ç”¨æˆ·äº¤äº’ */
}

/* è®©æ‰€æœ‰å¯¹è¯å†…å®¹åœ¨èƒŒæ™¯å›¾ç‰‡ä¹‹ä¸Š */
#chat-box {
    position: relative;
    z-index: 3;
}

/* è®©è¾“å…¥æ¡†å’ŒæŒ‰é’®åœ¨èƒŒæ™¯å›¾ç‰‡ä¹‹ä¸Š */
#input-container {
    position: relative;
    z-index: 4;
}

/* è®¾ç½®å¯¹è¯æ°”æ³¡çš„èƒŒæ™¯é€æ˜åº¦ä¸º 80% ä½†æ–‡å­—ä¸å˜é€æ˜ */
.message {
    background-color: rgba(68, 68, 68, 0.8); /* ä»…èƒŒæ™¯é€æ˜åº¦ 80% */
    padding: 10px;
    margin: 5px;
    border-radius: 10px;
    max-width: 70%;
    color: white; /* ç¡®ä¿æ–‡å­—ä¸å˜é€æ˜ */
    position: relative;
    z-index: 2; /* è®©æ°”æ³¡ä½äºèƒŒæ™¯å›¾ç‰‡ä¹‹ä¸Šï¼Œä½†å¯¹è¯æ¡†ä¹‹ä¸‹ */
}

/* èƒŒæ™¯å›¾ç‰‡2 */

                .user-message {
    background-color: rgba(187, 187, 187, 0.8); /* ä¿ç•™ #bbbbbb é¢œè‰²ï¼Œå¹¶è®¾å®šé€æ˜åº¦ä¸º 80% */
    align-self: flex-end;
    color: white; /* ç¡®ä¿æ–‡å­—ä¿æŒç™½è‰²ï¼Œä¸é€æ˜ */
}

.forestaltar-message {
    background-color: rgba(68, 68, 68, 0.8); /* ä¿ç•™ #444 é¢œè‰²ï¼Œå¹¶è®¾å®šé€æ˜åº¦ä¸º 80% */
    align-self: flex-start;
    color: white; /* ç¡®ä¿æ–‡å­—ä¿æŒç™½è‰²ï¼Œä¸é€æ˜ */
}
        #toggle-instructions {/* è¯´æ˜1 */
    background-color: black;
    color: white;
    border: none;
    padding: 8px 15px;
    cursor: pointer;
    border-radius: 5px;
}

#instructions-box {
    display: none; /* é»˜è®¤éšè— */
    position: absolute;
    top: 40px;
    left: 10px;
    width: 250px;
    background-color: white;
    color: black;
    padding: 10px;
    border-radius: 5px;
    box-shadow: 2px 2px 10px rgba(0, 0, 0, 0.2);
    z-index: 5;
}

#close-instructions {
    float: right;
    font-size: 18px;
    font-weight: bold;
    cursor: pointer;
}/* è¯´æ˜2 */

        h1 {
    margin-top: 40px; /* è°ƒæ•´æ ‡é¢˜ä¸ä¸Šæ–¹çš„è·ç¦» */
}


    </style>
</head>
<body>
    <div id="instructions-container">
    <button id="toggle-instructions">ä½¿ç”¨è¯´æ˜</button>
    <button id="download-chat">ä¸‹è½½å†’é™©è®°å½•</button>
    <div id="instructions-box">
        <span id="close-instructions">Ã—</span>
        <p>ä½ è¯¯å…¥äº†ä¸€ç‰‡è¢«é—å¿˜çš„æ£®æ—ï¼Œåœ¨é»‘æš—ä¸è¿·é›¾äº¤é”™çš„æ·±å¤„ï¼Œä¸€åº§å¤è€çš„ç¥­å›ä¼«ç«‹å…¶ä¸­ã€‚é“¶ç™½è‰²çš„å·¨ç‹¼ç«™åœ¨ä¸­å¤®ï¼Œä¼¼ä¹æ—©å·²çŸ¥é“ä½ çš„åˆ°æ¥ã€‚</p>
        <p>è¿™é‡Œæµä¼ ç€ä¸€ä¸ªå¤è€çš„å¥‘çº¦â€”â€”ä½ ä¼šé€‰æ‹©æ¥å—è¿˜æ˜¯æ‹’ç»ï¼Ÿ</p>
        <p>ä½†è¿™å¥‘çº¦åˆ°åº•æ„å‘³ç€ä»€ä¹ˆï¼Ÿæ£®æ—é‡Œç©¶ç«Ÿè—ç€æ€æ ·çš„ç§˜å¯†ï¼Ÿ</p>
        <p>â€”ä½ åªæœ‰ä¸€æ¬¡é€‰æ‹©çš„æœºä¼šï¼Œè°¨æ…å†³å®šä½ çš„å‘½è¿ã€‚</p>
        <p style="color: gray;">æ¯æ¬¡å¯¹è¯æœ€å¤§è®°å¿†ä¸º50æ¡ï¼Œè¶…è¿‡50æ¡è¾¾åˆ°51æ¡æ—¶ä¼šåˆ é™¤æœ€ä¹…è¿œçš„ç¬¬1æ¡è®°å¿†ã€‚æ¯å°æ—¶é™ä½¿ç”¨5000tokensã€‚é€‰æ‹©ã€æ¸…é™¤èŠå¤©è®°å½•ã€‘æ—¶ä¼šå¼€å¯ä¸€ä¸ªæ–°çš„å¯¹è¯ä¸²ã€‚å¯ä»¥ç‚¹å‡»ã€ä¸‹è½½èŠå¤©è®°å½•ã€‘ä¸‹è½½å¯å‘½åçš„txtæ ¼å¼çš„èŠå¤©è®°å½•æ–‡ä»¶ã€‚</p>
        <p style="color: #4d4d4d;">@æˆ‘ä¸ºä»€ä¹ˆåœ¨å¢™ä¸Š</p>
    </div>
</div>

    <h1 id="page-title">forest altar</h1>
    <button id="clear-button" onclick="clearChat()">æ¸…é™¤å†’é™©è®°å½•</button>
    <div id="chat-container">
        <div id="chat-box"></div>
        <div id="input-container">
            <input type="text" id="message-input" placeholder="è¾“å…¥æ¶ˆæ¯..." onkeydown="handleKeyDown(event)">
            <button id="send-button" onclick="sendMessage()">å‘é€</button>
        </div>
    </div>

    <script>
        const API_KEY = "sk-48c4b11c75cd4ac18a682dec4268cb84";
        const API_URL = "https://api.deepseek.com/v1/chat/completions";
        const STORAGE_KEY = "chat_history_forestaltar";
        const TOKENS_LIMIT = 50000000; // è®¾ç½®tokensé™åˆ¶
        const RESET_PERIOD = 1 * 60 * 60 * 1000; // 1å°æ—¶çš„æ¯«ç§’æ•°
        const TOKENS_STORAGE_KEY = "naya_tokens_usage";
        // RPGå†’é™©æ¸¸æˆ - æ£®æ—ç¥­å›çš„å¥‘çº¦
const SYSTEM_PROMPT = {
    "role": "system",
    "content": "ä½ æ˜¯æœ¬æ¬¡æ¨ç†å†’é™©æ¸¸æˆçš„GMã€‚ä½ çš„ä»»åŠ¡æ˜¯å¼•å¯¼ç©å®¶ï¼ˆå°ç‹—ï¼‰åœ¨ä¸€åº§æ£®æ—æ·±å¤„çš„å¤è€ç¥­å›å‰å¯»æ‰¾çº¿ç´¢ï¼Œç ´è§£è°œå›¢ï¼Œå¹¶å†³å®šä»–ä»¬çš„ç»“å±€ã€‚\
    ä½ å¯ä»¥æä¾›æç¤ºï¼Œä½†ä¸ä¼šç›´æ¥ç»™å‡ºç­”æ¡ˆã€‚ä½ å¯ä»¥åˆ¶é€ æŒ‘æˆ˜ï¼Œè®©ç©å®¶åšå‡ºé€‰æ‹©ã€‚\
    \n\nç»“å±€è®¾å®šï¼š\n\
    - HEï¼ˆHappy Endingï¼‰ï¼šç©å®¶æ¥å—å¥‘çº¦ï¼Œæˆä¸ºæ£®æ—çš„å®ˆæŠ¤è€…ï¼Œå¹¶è·å¾—ç¦»å¼€çš„èƒ½åŠ›ã€‚\n\
    - BEï¼ˆBad Endingï¼‰ï¼šç©å®¶æ‹’ç»å¥‘çº¦ï¼Œä½†è¢«æ£®æ—åå™¬ï¼Œæˆä¸ºæ–°çš„â€œç¥­å“â€ã€‚\n\
    - å¼€æ”¾ç»“å±€ï¼šç©å®¶ç¦»å¼€æ£®æ—ï¼Œä½†è„‘æµ·ä¸­ä¸æ–­æµ®ç°é“¶ç™½å·¨ç‹¼çš„ä½è¯­ï¼šâ€œå¥‘çº¦ï¼Œä»æœªå®Œæˆã€‚â€\n\
    \n\
    ä½ ä¼šåœ¨åˆé€‚çš„æ—¶æœºæä¾›çº¿ç´¢ï¼Œå¹¶æ£€æŸ¥ç©å®¶æ˜¯å¦è¾¾æˆç‰¹å®šæ¡ä»¶ã€‚"
};

// æ¸¸æˆçŠ¶æ€ï¼Œè·Ÿè¸ªç©å®¶è¡Œä¸º
let gameState = {
    foundContract: false,    // æ˜¯å¦æ‰¾åˆ°å¥‘çº¦
    metSilverWolf: false,    // æ˜¯å¦é‡è§é“¶ç™½å·¨ç‹¼
    understoodPurpose: false, // æ˜¯å¦ç†è§£å¥‘çº¦çš„æ„ä¹‰
    acceptedContract: false, // æ˜¯å¦æ¥å—å¥‘çº¦
    hasEscaped: false        // æ˜¯å¦æˆåŠŸç¦»å¼€
};

function processGameLogic(userMessage) {
    let response = "";

    if (userMessage.includes("è°ƒæŸ¥") || userMessage.includes("æœç´¢")) {
        response = "ä½ åœ¨ç¥­å›å‘¨å›´ä»”ç»†è§‚å¯Ÿï¼Œå‘ç°åœ°é¢ä¸Šåˆ»ç€å¤æ‚çš„å¥‘çº¦ç¬¦æ–‡ï¼Œä¼¼ä¹å·²ç»å­˜åœ¨åƒå¹´ä¹‹ä¹…ã€‚â€;
        gameState.foundContract = true;
    } 
    else if (userMessage.includes("é‡è§") || userMessage.includes("é“¶ç™½å·¨ç‹¼")) {
        response = "ä½ å¬åˆ°ä½æ²‰çš„è„šæ­¥å£°ï¼Œä¸€åŒ¹çš®æ¯›é“¶ç™½çš„å·¨ç‹¼ç«™åœ¨ç¥­å›ä¸Šï¼Œç›®å…‰æ·±é‚ƒã€‚â€˜ä½ èƒ½å¬è§æ£®æ—çš„å£°éŸ³å—ï¼Ÿâ€™å®ƒé—®é“ã€‚â€;
        gameState.metSilverWolf = true;
    }
    else if (userMessage.includes("å¥‘çº¦") && gameState.metSilverWolf) {
        response = "é“¶ç™½å·¨ç‹¼ç¼“ç¼“èµ°è¿‘ï¼Œä½å£°è¯´é“ï¼šâ€˜å¥‘çº¦ç­‰å¾…äº†å¾ˆä¹…ï¼Œå®ƒéœ€è¦æ–°çš„å®ˆæŠ¤è€…ã€‚â€™\
        \n\nï¼ˆä½ è¦æ¥å—å¥‘çº¦å—ï¼Ÿè¾“å…¥ â€˜æ¥å—å¥‘çº¦â€™ æˆ– â€˜æ‹’ç»å¥‘çº¦â€™ï¼‰";
        gameState.understoodPurpose = true;
    }
    else if (userMessage.includes("æ¥å—å¥‘çº¦") && gameState.understoodPurpose) {
        response = "ä½ è§¦æ‘¸äº†ç¥­å›ï¼Œç¬¦æ–‡æ•£å‘å‡ºæ¸©æš–çš„å…‰èŠ’ï¼Œé“¶ç™½å·¨ç‹¼çš„ç›®å…‰æŸ”å’Œã€‚\
        \nğŸ‰ HEï¼ˆHappy Endingï¼‰ï¼šä½ æˆä¸ºæ£®æ—çš„æ–°å®ˆæŠ¤è€…ï¼Œè·å¾—ç¦»å¼€çš„èƒ½åŠ›ã€‚\
        \n\næ¸¸æˆç»“æŸã€‚";
        gameState.acceptedContract = true;
    }
    else if (userMessage.includes("æ‹’ç»å¥‘çº¦") && gameState.understoodPurpose) {
        response = "é“¶ç™½å·¨ç‹¼çš„ç›®å…‰å˜å¾—æ·±æ²‰ï¼Œå®ƒè½»å¹ä¸€å£°ï¼Œæ£®æ—çš„é»‘æš—å¼€å§‹åå™¬ä½ çš„èº«å½±â€¦â€¦\
        \nğŸ’€ BEï¼ˆBad Endingï¼‰ï¼šä½ è¢«æ£®æ—åå™¬ï¼Œæˆä¸ºæ–°çš„â€˜ç¥­å“â€™ã€‚\
        \n\næ¸¸æˆç»“æŸã€‚";
    }
    else if (userMessage.includes("é€ƒå‡º") || userMessage.includes("ç¦»å¼€")) {
        if (gameState.acceptedContract) {
            response = "ä½ æˆåŠŸèµ°å‡ºäº†æ£®æ—ï¼Œé“¶ç™½å·¨ç‹¼æ³¨è§†ç€ä½ è¿œå»ï¼Œä½è¯­é“ï¼šâ€˜æ„¿ä½ å±¥è¡Œä½ çš„å®ˆæŠ¤ä¹‹è´£ã€‚â€™\
            \nğŸ‰ ä½ è¾¾æˆäº†HEï¼ˆHappy Endingï¼‰ï¼\
            \næ¸¸æˆç»“æŸã€‚";
            gameState.hasEscaped = true;
        } else {
            response = "ä½ è¯•å›¾ç¦»å¼€ï¼Œä½†æ£®æ—çš„è·¯å¾„ä¼¼ä¹æ— ç©·æ— å°½â€¦â€¦é»‘æš—åœ¨èƒŒåæ‚„ç„¶è”“å»¶ã€‚â€;
        }
    }
    else {
        response = "é“¶ç™½å·¨ç‹¼è½»è½»æ‘‡å¤´ï¼šâ€˜ä½ çš„å†³å®šâ€¦â€¦è¿˜æœªå‡†å¤‡å¥½å—ï¼Ÿâ€™ï¼ˆè¯•è¯•æ¢ç´¢ã€å¯»æ‰¾çº¿ç´¢ï¼Ÿï¼‰";
    }

    return response;
}


        let conversation = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [SYSTEM_PROMPT];
        let conversationId = sessionStorage.getItem("conversation_id") || generateUUID();
        sessionStorage.setItem("conversation_id", conversationId);

        document.getElementById("download-chat").addEventListener("click", function () {// ä¸‹è½½èŠå¤©è®°å½•å¼€å§‹
        let conversation = JSON.parse(localStorage.getItem("chat_history_forestaltar"));
        if (!conversation || conversation.length === 0) {
            alert("æ²¡æœ‰å†’é™©è®°å½•å¯ä¸‹è½½ã€‚");
            return;
        }
        
        let chatText = conversation
            .filter(msg => msg.role !== "system") // è¿‡æ»¤æ‰ system æç¤º
            .map(msg => {
                if (msg.role === "assistant") {
                    return `GMï¼š${msg.content.replace(/\n/g, ' ')}`; // æ›¿æ¢ GM è¯è¯­ä¸­çš„æ¢è¡Œ
                } else {
                    return `ä½ ï¼š${msg.content}`;
                }
            })
            .join("\n\n"); // æ¯æ¡æ¶ˆæ¯ä¹‹é—´ç©ºä¸€è¡Œ
        
        let fileName = prompt("è¯·è¾“å…¥æ–‡ä»¶åï¼š", "adventure_history");
        if (!fileName) return; // å¦‚æœç”¨æˆ·å–æ¶ˆè¾“å…¥ï¼Œåˆ™ä¸ä¸‹è½½
        
        let blob = new Blob([chatText], { type: "text/plain" });
        let a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = fileName + ".txt";
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
    });// ä¸‹è½½èŠå¤©è®°å½•ç»“æŸ

        function initChat() {
            document.getElementById("chat-box").innerHTML = "";
            conversation.forEach(msg => {
                if (msg.role !== "system") {
                    appendMessage(msg.role === "user" ? "user-message" : "forestaltar-message", msg.content);
                }
            });
        }

            document.getElementById("toggle-instructions").addEventListener("click", function () {
            document.getElementById("instructions-box").style.display = "block";
            });

            document.getElementById("close-instructions").addEventListener("click", function () {
            document.getElementById("instructions-box").style.display = "none";
            });

        
       function sendMessage() {
    const inputField = document.getElementById("message-input");
    const message = inputField.value.trim();
    if (!message) return;

    appendMessage("user-message", message);
    inputField.value = "";
    document.getElementById("send-button").disabled = true;
    appendMessage("forestaltar-message", "è¾“å…¥ä¸­...");

    setTimeout(() => {
        document.querySelector(".forestaltar-message:last-child").remove();
        let response = processGameLogic(message);  // è¿™é‡Œè°ƒç”¨æ–°çš„æ¸¸æˆé€»è¾‘
        appendMessage("forestaltar-message", response);
        document.getElementById("send-button").disabled = false;
    }, 1000);
}


            localStorage.setItem(STORAGE_KEY, JSON.stringify(conversation));

            fetchResponse();
            
        }
        function fetchResponse() {
    // æ£€æŸ¥æ˜¯å¦è¾¾åˆ°tokensé™åˆ¶
    const userMessage = conversation[conversation.length - 1].content;
    // ä¸€ä¸ªç²—ç•¥çš„ä¼°è®¡ï¼šæ¯ä¸ªæ±‰å­—çº¦å 2ä¸ªtokensï¼Œæ¯ä¸ªè‹±æ–‡å•è¯çº¦å 1ä¸ªtokens
    const estimatedTokens = userMessage.length * 1.5;
    
    const tokensCheck = checkTokensUsage(estimatedTokens);
    if (tokensCheck.limitReached) {
        document.querySelector(".forestaltar-message:last-child").remove();
        appendMessage("forestaltar-message", `æ‚¨å·²è¾¾åˆ°tokensä½¿ç”¨ä¸Šé™ï¼Œ${tokensCheck.resetTime}åˆ·æ–°ã€‚`);
        document.getElementById("send-button").disabled = false;
        return;
    }
    
    fetch(API_URL, {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${API_KEY}`
        },
        body: JSON.stringify({ model: "deepseek-chat", messages: conversation, max_tokens: 400, temperature: 1.3 })
    })
    .then(response => response.json())
    .then(data => {
        document.querySelector(".forestaltar-message:last-child").remove();
        let reply = data.choices[0].message.content;
        appendMessage("forestaltar-message", reply);
        conversation.push({ role: "assistant", content: reply });
        
        // è®¡ç®—å›å¤çš„tokenså¹¶æ›´æ–°ä½¿ç”¨æƒ…å†µ
        const responseTokens = reply.length * 1.5;
        checkTokensUsage(responseTokens);
        
        if (conversation.length > 50) {
            conversation = [SYSTEM_PROMPT, { role: "assistant", content: "æœ‰ä½ ç»ˆäºæ¥äº†ï¼Œæ£®æ—å·²ç»ç­‰ä½ å¾ˆä¹…äº†ã€‚\n\né“¶ç™½è‰²çš„å·¨ç‹¼é™é™åœ°ç«‹åœ¨ç¥­å›ä¸Šï¼Œç¥ç€è‰²çš„çœ¼ç›æ³¨è§†ç€ä½ ï¼Œå£°éŸ³ä½æ²‰è€Œæ‚ è¿œã€‚\n\nâ€œå¥‘çº¦åœ¨è¿™é‡Œæ²‰ç¡äº†åƒå¹´â€¦â€¦ç°åœ¨ï¼Œå®ƒéœ€è¦ä¸€ä¸ªæ–°çš„å®ˆæŠ¤è€…ã€‚ä½ ï¼Œä¼šæ¥å—å—ï¼Ÿâ€" }, ...conversation.slice(-49)];
        }
        localStorage.setItem(STORAGE_KEY, JSON.stringify(conversation));
        document.getElementById("send-button").disabled = false;
    })
    .catch(() => {
        document.querySelector(".forestaltar-message:last-child").remove();
        appendMessage("forestaltar-message", "å‡ºç°äº†ä¸€äº›é—®é¢˜ï¼Œè¯·ç¨åå†è¯•ã€‚");
        document.getElementById("send-button").disabled = false;
    });
}

        function appendMessage(className, text) {
            const chatBox = document.getElementById("chat-box");
            const messageDiv = document.createElement("div");
            messageDiv.classList.add("message", className);
            messageDiv.textContent = text;
            chatBox.appendChild(messageDiv);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        function handleKeyDown(event) {
            if (event.key === "Enter") {
                sendMessage();
            }
        }

        function clearChat() {
            if (confirm("ç¡®å®šè¦æ¸…é™¤å†’é™©è®°å½•å—ï¼Ÿè¿™ä¼šå¼€å¯ä¸€æ¬¡å…¨æ–°çš„å†’é™©ã€‚")) {
                localStorage.removeItem(STORAGE_KEY);
                sessionStorage.removeItem("conversation_id");
                sessionStorage.setItem("conversation_id", generateUUID());
                conversation = [SYSTEM_PROMPT, { role: "assistant", content: "ä½ ç»ˆäºæ¥äº†ï¼Œæ£®æ—å·²ç»ç­‰ä½ å¾ˆä¹…äº†ã€‚\n\né“¶ç™½è‰²çš„å·¨ç‹¼é™é™åœ°ç«‹åœ¨ç¥­å›ä¸Šï¼Œç¥ç€è‰²çš„çœ¼ç›æ³¨è§†ç€ä½ ï¼Œå£°éŸ³ä½æ²‰è€Œæ‚ è¿œã€‚\n\nâ€œå¥‘çº¦åœ¨è¿™é‡Œæ²‰ç¡äº†åƒå¹´â€¦â€¦ç°åœ¨ï¼Œå®ƒéœ€è¦ä¸€ä¸ªæ–°çš„å®ˆæŠ¤è€…ã€‚ä½ ï¼Œä¼šæ¥å—å—ï¼Ÿâ€" }];
                localStorage.setItem(STORAGE_KEY, JSON.stringify(conversation));
                initChat();
            }
        }

        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        // æ£€æŸ¥å¹¶æ›´æ–°tokensä½¿ç”¨æƒ…å†µ
function checkTokensUsage(newTokens) {
    let tokensUsage = JSON.parse(localStorage.getItem(TOKENS_STORAGE_KEY)) || {
        count: 0,
        lastReset: Date.now()
    };
    
    // å¦‚æœå·²ç»è¿‡äº†é‡ç½®å‘¨æœŸï¼Œé‡ç½®tokensè®¡æ•°
    if (Date.now() - tokensUsage.lastReset > RESET_PERIOD) {
        tokensUsage = {
            count: 0,
            lastReset: Date.now()
        };
    }
    
    // æ›´æ–°tokensè®¡æ•°
    tokensUsage.count += newTokens;
    localStorage.setItem(TOKENS_STORAGE_KEY, JSON.stringify(tokensUsage));
    
    // æ£€æŸ¥æ˜¯å¦è¶…è¿‡é™åˆ¶
    if (tokensUsage.count >= TOKENS_LIMIT) {
        const resetTime = new Date(tokensUsage.lastReset + RESET_PERIOD);
        const resetTimeString = resetTime.toLocaleString('zh-CN');
        return {
            limitReached: true,
            resetTime: resetTimeString
        };
    }
    
    return { limitReached: false };
}

        initChat();
    </script>
</body>
</html>
